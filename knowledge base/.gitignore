# ============================================================================
# FICHIER : scripts/run_migration.py
# DESCRIPTION : Script pour ex√©cuter la migration
# ============================================================================

import sys
import os
import subprocess

# Ajouter le chemin backend au PYTHONPATH
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'backend'))

from app.config import settings


def run_migration():
    """
    Ex√©cute la migration SQL
    """
    print("üîß Ex√©cution de la migration 001_add_workflow_fields...")
    
    try:
        # Chemin vers le fichier de migration
        migration_file = os.path.join(
            os.path.dirname(__file__),
            '..',
            'database',
            'migrations',
            '001_add_workflow_fields.sql'
        )
        
        # Extraire les infos de connexion depuis DATABASE_URL
        db_url = settings.DATABASE_URL
        parts = db_url.replace("postgresql://", "").split("@")
        user_pass = parts[0].split(":")
        host_db = parts[1].split("/")
        host_port = host_db[0].split(":")
        
        user = user_pass[0]
        password = user_pass[1]
        host = host_port[0]
        port = host_port[1]
        database = host_db[1]
        
        # Ex√©cuter la migration
        os.environ['PGPASSWORD'] = password
        result = subprocess.run(
            ['psql', '-h', host, '-p', port, '-U', user, '-d', database, '-f', migration_file],
            capture_output=True,
            text=True
        )
        
        if result.returncode == 0:
            print("‚úÖ Migration ex√©cut√©e avec succ√®s!")
            print(result.stdout)
        else:
            print(f"‚ùå Erreur lors de la migration:")
            print(result.stderr)
            sys.exit(1)
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        sys.exit(1)


if __name__ == "__main__":
    run_migration()